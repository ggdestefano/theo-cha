<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ch√° de Beb√™ Theo - Lista de Presentes</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; padding: 20px; }
        h1 { text-align: center; color: #4a90e2; }
        ul { list-style: none; padding: 0; }
        li { margin: 10px 0; padding: 10px; border: 1px solid #ddd; border-radius: 5px; background: #f9f9f9; }
        input[type="checkbox"] { margin-right: 10px; }
        .taken { text-decoration: line-through; color: #999; opacity: 0.6; background: #ffebee !important; }
        .taken input[type="checkbox"] { display: none; }
        .taken::before { content: "‚úÖ Tomado! "; font-weight: bold; }
        button { background: #4a90e2; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; }
        button:hover { background: #357abd; }
        #loading { text-align: center; color: #666; }
        .disabled { opacity: 0.5; pointer-events: none; }
    </style>
</head>
<body>
    <h1>Ch√° de Beb√™ Theo üéâ</h1>
    <p>Selecione um presente abaixo. Itens j√° escolhidos pelos convidados ficam riscados e indispon√≠veis.</p>
    
    <ul id="presentesList">
        <li id="loading">Carregando itens...</li>
    </ul>
    
    <p style="text-align: center; margin-top: 20px;">
        <button onclick="salvarSelecao('Body Manga Longa (6-9)')">Exemplo: Selecionar Body Manga Longa</button>
    </p>

    <script>
        const presentes = [
            'Body Manga Longa (6-9)',
            'Body Manga Curta (6-9)',
            'Kit de len√ßos umedecidos',
            'Shampoo e sabonete baby',
            'Conjunto de roupinhas de banho',
            'Escova e pente',
            'Conjunto de potinhos para papinhas',
            'Babador',
            'Manta',
            'Cortador de unhas para beb√™',
            'Macac√£o de dormir',
            'Urso de pel√∫cia',
            'Almofada de amamenta√ß√£o',
            'Pomada para Assadura',
            'Cueiro',
            'Paninho de Boca',
            'Toalha de banho',
            'Mij√£ozinho',
            'Sapatinhos',
            'Meias',
            'Aspirador Nasal',
            'Naninha',
            'Trocador',
            'Talco',
            'Saboneteira'
        ];

        async function carregarTakenItems() {
            try {
                const response = await fetch('/.netlify/functions/get-submissions');
                if (!response.ok) throw new Error('Erro na fun√ß√£o');
                const data = await response.json();
                return new Set(data.takenItems || []);
            } catch (error) {
                console.error('Erro ao carregar:', error);
                return new Set();
            }
        }

        async function renderizarLista() {
            const taken = await carregarTakenItems();
            const list = document.getElementById('presentesList');
            list.innerHTML = '';

            presentes.forEach(item => {
                const li = document.createElement('li');
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.id = item.replace(/\s+/g, '-').toLowerCase();

                const label = document.createElement('label');
                label.htmlFor = checkbox.id;
                label.textContent = item;

                li.appendChild(checkbox);
                li.appendChild(label);

                if (taken.has(item)) {
                    li.classList.add('taken');
                } else {
                    checkbox.addEventListener('change', async () => {
                        if (checkbox.checked) {
                            const success = await salvarSelecao(item);
                            if (success) {
                                li.classList.add('taken');
                                checkbox.disabled = true; // Bloqueia ap√≥s salvar
                            } else {
                                checkbox.checked = false; // Desmarca se falhar
                            }
                        }
                    });
                }

                list.appendChild(li);
            });
        }

        async function salvarSelecao(item) {
            try {
                const response = await fetch('/.netlify/functions/submit-presente', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ presente: item })
                });
                if (response.ok) {
                    alert(`Obrigado! "${item}" foi reservado. Recarregue a p√°gina pra ver atualizado pros outros.`);
                    // N√£o recarrega automaticamente, deixa o usu√°rio fazer manualmente
                    return true;
                } else {
                    throw new Error('Falha ao salvar');
                }
            } catch (error) {
                console.error('Erro ao salvar:', error);
                alert('Erro ao reservar o presente. Tente novamente.');
                return false;
            }
        }

        renderizarLista();

        setInterval(renderizarLista, 30000); // Recarrega a lista a cada 30 segundos
    </script>
</body>
</html>
