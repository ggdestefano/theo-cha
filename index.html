<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ChÃ¡ de bebÃª do ThÃ©o - Lista de Presentes</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 600px;
      margin: 0 auto;
      padding: 20px;
      background-color: #4a90e2;
      color: #fff;
    }
    h1 {
      text-align: center;
      font-size: 2em;
      margin-bottom: 10px;
    }
    .event-info {
      text-align: center;
      font-size: 1.2em;
      margin-bottom: 20px;
    }
    ul {
      list-style: none;
      padding: 0;
    }
    li {
      margin: 10px 0;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 5px;
      background: #fff;
      color: #333;
      display: flex;
      align-items: center;
    }
    input[type="checkbox"] {
      margin-right: 10px;
    }
    .taken {
      text-decoration: line-through;
      color: #999;
      opacity: 0.6;
      background: #ffebee !important;
      position: relative;
    }
    .taken input[type="checkbox"] {
      display: none;
    }
    .taken::before {
      content: "âœ… Limite atingido! ";
      font-weight: bold;
      position: absolute;
      left: 10px;
      top: 10px;
    }
    button {
      background: #fff;
      color: #4a90e2;
      padding: 10px 20px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      width: 100%;
      margin: 5px 0;
      font-size: 1em;
    }
    button:hover {
      background: #e0e0e0;
    }
    #loading {
      text-align: center;
      color: #fff;
    }
    .form-group {
      margin: 20px 0;
    }
    input[type="text"],
    input[type="password"] {
      width: 100%;
      padding: 10px;
      margin-bottom: 10px;
      border: 1px solid #ddd;
      border-radius: 5px;
      background: #fff;
      color: #333;
      font-size: 1em;
    }
    #senha-zera {
      display: none;
      margin-top: 10px;
    }
    #senha-zera.active {
      display: block;
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
</head>
<body>
  <h1>ðŸŽˆ ChÃ¡ de bebÃª do ThÃ©o ðŸŽˆ</h1>
  <div class="event-info">Data do evento: 09/11/2025 Ã s 15:00</div>

  <div class="form-group">
    <input type="text" id="nome" placeholder="Digite seu nome" required />
  </div>

  <p>Selecione um ou mais presentes abaixo e envie sua resposta.</p>

  <ul id="presentesList">
    <li id="loading">Carregando itens...</li>
  </ul>

  <p style="text-align: center; margin-top: 20px;">
    <button onclick="enviarFormulario()">Enviar Resposta</button>
    <button onclick="mostrarSenhaZerar()">Zerar Lista</button>
  </p>

  <div id="senha-zera">
    <input type="password" id="input-senha" placeholder="Digite a senha para zerar" />
    <button onclick="zerarLista()">Confirmar</button>
  </div>

  <script>
    // Inicializa EmailJS
    (function () {
      emailjs.init("Nt9goDnO2YFhX8RET");
      console.log("EmailJS inicializado.");
    })();

    const URL_APPS_SCRIPT =
      "https://script.google.com/macros/s/AKfycbxg9a7M1rI9eJRabn6LFZe8BqoELhf9K602Taz1B6UJw0fam3XAmJVhiTI5qRnO1t2nbw/exec";
    const SENHA_ZERAR = "thÃ©o2025";

    // FunÃ§Ã£o para carregar os contadores da API do Google Apps Script
    async function carregarContadores() {
      try {
        const response = await fetch(URL_APPS_SCRIPT);
        const data = await response.json();
        console.log("Contadores carregados:", data);
        return data;
      } catch (error) {
        console.error("Erro ao carregar contadores:", error);
        return {};
      }
    }

    // FunÃ§Ã£o para incrementar contador do item na API
    async function atualizarContador(item) {
      try {
        await fetch(URL_APPS_SCRIPT, {
          method: "POST",
          body: JSON.stringify({ item: item, action: "increment" }),
          headers: { "Content-Type": "application/json" },
        });
        console.log(`Contador atualizado para item: ${item}`);
      } catch (error) {
        console.error("Erro ao atualizar contador:", error);
      }
    }

    // FunÃ§Ã£o para verificar se item jÃ¡ atingiu limite
    function estaTomado(item, contadores) {
      const chave = item.toLowerCase().replace(/\s+/g, "_");
      const { contador = 0, limite = 0 } = contadores[chave] || {};
      return contador >= limite;
    }

    // Mostra campo senha para zerar lista
    function mostrarSenhaZerar() {
      document.getElementById("senha-zera").classList.add("active");
    }

    // Zera todos os contadores com senha
    async function zerarLista() {
      const senha = document.getElementById("input-senha").value;
      if (senha === SENHA_ZERAR) {
        try {
          await fetch(URL_APPS_SCRIPT, {
            method: "POST",
            body: JSON.stringify({ action: "reset" }),
            headers: { "Content-Type": "application/json" },
          });
          alert("Lista zerada!");
          document.getElementById("senha-zera").classList.remove("active");
          document.getElementById("input-senha").value = "";
          await renderizarLista();
        } catch (error) {
          console.error("Erro ao zerar lista:", error);
          alert("Erro ao zerar lista.");
        }
      } else {
        alert("Senha errada!");
      }
    }

    // FunÃ§Ã£o para renderizar a lista de presentes com base nos contadores atuais
    async function renderizarLista() {
      const list = document.getElementById("presentesList");
      list.innerHTML = '<li id="loading">Carregando itens...</li>';

      const contadores = await carregarContadores();
      list.innerHTML = "";

      const presentes = [
        "Body Manga Longa (6-9)",
        "Body Manga Curta (6-9)",
        "Kit de lenÃ§os umedecidos",
        "Shampoo e sabonete baby",
        "Conjunto de roupinhas de banho",
        "Escova e pente",
        "Conjunto de potinhos para papinhas",
        "Babador",
        "Manta",
        "Cortador de unhas para bebÃª",
        "MacacÃ£o de dormir",
        "Urso de pelÃºcia",
        "Almofada de amamentaÃ§Ã£o",
        "Pomada para Assadura",
        "Cueiro",
        "Paninho de Boca",
        "Toalha de banho",
        "MijÃ£ozinho",
        "Sapatinhos",
        "Meias",
        "Aspirador Nasal",
        "Naninha",
        "Trocador",
        "Talco",
        "Saboneteira",
      ];

      presentes.forEach((item) => {
        const li = document.createElement("li");
        const checkbox = document.createElement("input");
        checkbox.type = "checkbox";
        checkbox.id = item.toLowerCase().replace(/\s+/g, "-");
        checkbox.name = "presentes";

        const label = document.createElement("label");
        label.htmlFor = checkbox.id;
        label.textContent = item;

        li.appendChild(checkbox);
        li.appendChild(label);

        if (estaTomado(item, contadores)) {
          li.classList.add("taken");
          checkbox.disabled = true;
        }

        list.appendChild(li);
      });
    }

    // FunÃ§Ã£o para enviar o formulÃ¡rio e atualizar os contadores
    async function enviarFormulario() {
      const nome = document.getElementById("nome").value.trim();
      if (!nome) {
        alert("Digite seu nome!");
        return;
      }

      const selecionados = Array.from(
        document.querySelectorAll('input[name="presentes"]:checked')
      ).map((cb) => cb.nextElementSibling.textContent);

      if (selecionados.length === 0) {
        alert("Selecione um presente!");
        return;
      }

      const contadores = await carregarContadores();

      for (let item of selecionados) {
        if (estaTomado(item, contadores)) {
          alert(`${item} atingiu o limite!`);
          return;
        }
      }

      try {
        await emailjs.send("service_2jq56gm", "template_007ur9o", {
          nome: nome,
          presentes: selecionados.join(", "),
        });

        for (let item of selecionados) {
          await atualizarContador(item);
        }

        // Espera um segundo para garantir que o Apps Script atualize a planilha
        await new Promise((resolve) => setTimeout(resolve, 1000));

        await renderizarLista();

        alert(`Obrigado, ${nome}!`);
        document.getElementById("nome").value = "";
        document.querySelectorAll('input[name="presentes"]:checked').forEach((cb) => (cb.checked = false));
      } catch (error) {
        console.error("Erro no envio:", error);
        alert("Erro no envio. Verifique o console.");
      }
    }

    // Inicializa renderizaÃ§Ã£o da lista ao carregar pÃ¡gina
    renderizarLista();
  </script>
</body>
</html>

